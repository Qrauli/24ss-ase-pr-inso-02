<app-header title="Dispatcher"></app-header>
<div class="container">
  <div class="section-1">
    <div class="center-heading heading-coloring">
      <p style="color: white">Einsatz-Liste</p>
    </div>
    <div class="section-vert-1 scrollsection" [ngClass]="{'section-vert-1-checked' : selectedIncident !== null}"
      style="border-bottom: 1px solid #ccc;">

      <table mat-table [dataSource]="incidents" class="mat-elevation-z8 incident-table">
        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Dispatch Status </th>
          <td mat-cell *matCellDef="let element">
            <mat-icon *ngIf="element.state == 'DISPATCHED'" class="check" fontIcon="check"></mat-icon>
            <mat-icon *ngIf="element.state != 'DISPATCHED'" class="notcheck" fontIcon="close"></mat-icon>
            <mat-icon *ngIf="hasRequest(element)" matTooltip="Anfrage für zusätzliche Resourcen" style="margin-left: 5px; color: blue;" fontIcon="message"></mat-icon>
          </td>
        </ng-container>

        <!-- Location Column -->
        <ng-container matColumnDef="location" >
          <th mat-header-cell *matHeaderCellDef> Standort </th>
          <td mat-cell *matCellDef="let element"> {{element.location?.address?.street}}, {{element.location?.address?.postalCode}} {{element.location?.address?.city}} </td>
        </ng-container>

        <!-- Classification Column -->
        <ng-container matColumnDef="class">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Klassifikation </th>
          <td mat-cell *matCellDef="let element"> {{element.code}} </td>
        </ng-container>

        <tr mat-row (click)="selectIncident(row)" [ngClass]="{'selected-incident': row.id == selectedIncident}"
          *matRowDef="let row; columns: displayedColumnsIncidents;"></tr>
      </table>
    </div>
    <div class="center-heading heading-coloring">
      <p style="color: white">Ausgewählter Einsatz</p>
      <button style="position:absolute; right: 3px;" mat-icon-button (click)="unselectIncident()"
      [disabled]="selectedIncident === null" aria-label="Einsatz abwählen" matTooltip="Einsatz abwählen" >
      <mat-icon [ngClass]="{'white-icon': selectedIncident !== null}">deselect</mat-icon>
    </button>
    </div>
    <div class="section-vert-2 scrollsection" *ngIf="selectedIncident !== null">
      <mat-grid-list cols="5" rowHeight="50px">
        <mat-grid-tile colspan="2" class="incident-key">Dispatch Status</mat-grid-tile>
        <mat-grid-tile colspan="3" class="incident-property">{{selectedIncidentData?.state}}</mat-grid-tile>
        <mat-grid-tile colspan="2" class="incident-key">Klassifikation</mat-grid-tile>
        <mat-grid-tile colspan="3" class="incident-property">{{selectedIncidentData?.code}}</mat-grid-tile>
      </mat-grid-list>
      <br *ngIf="hasRequest(selectedIncidentData!)">
      <mat-grid-list *ngIf="hasRequest(selectedIncidentData!)"  cols="5" rowHeight="50px">
        <mat-grid-tile colspan="5" class="incident-property" style="background-color: lightgrey;"><i>Zusätzliche Resourcenanfragen</i></mat-grid-tile>
        <ng-container *ngFor="let request of getRequests(selectedIncidentData!)">
          <mat-grid-tile colspan="2" class="key-normal">{{request.requestedResourceType}}</mat-grid-tile>
          <mat-grid-tile colspan="2" class="key-normal">{{request.resourceId}}</mat-grid-tile>
          <mat-grid-tile colspan="1" class="property">
            <button (click)="finishRequest(request)" mat-icon-button aria-label="Resourcen-Anfrage abschließen">
            <mat-icon style="color: blue">task_alt</mat-icon>
          </button>
        </mat-grid-tile>
        </ng-container>
      </mat-grid-list>
      <br>
      <mat-grid-list cols="5" rowHeight="50px">
        <mat-grid-tile colspan="5" class="incident-property" style="background-color: lightgrey;"><i>Standort</i></mat-grid-tile>
        <mat-grid-tile colspan="2" class="incident-key">PLZ</mat-grid-tile>
        <mat-grid-tile colspan="3" class="incident-property">{{selectedIncidentData?.location?.address?.postalCode}}</mat-grid-tile>
        <mat-grid-tile colspan="2" class="incident-key">Ort</mat-grid-tile>
        <mat-grid-tile colspan="3" class="incident-property">{{selectedIncidentData?.location?.address?.city}}</mat-grid-tile>
        <mat-grid-tile colspan="2" class="incident-key">Straße</mat-grid-tile>
        <mat-grid-tile colspan="3" class="incident-property">{{selectedIncidentData?.location?.address?.street}}</mat-grid-tile>
        <mat-grid-tile colspan="2" rowspan="2" class="incident-key">Zusätzliche Standortinformationen</mat-grid-tile>
        <mat-grid-tile colspan="3" rowspan="2" class="incident-property">{{selectedIncidentData?.location?.address?.additionalInformation}}</mat-grid-tile>
      </mat-grid-list>
      <br>
      <mat-grid-list cols="6" rowHeight="50px">
        <mat-grid-tile colspan="6" class="incident-property" style="background-color: lightgrey;"><i>AnruferIn</i></mat-grid-tile>
        <mat-grid-tile colspan="2" class="key-normal">Max Mustermann</mat-grid-tile>
        <mat-grid-tile colspan="2" class="key-normal">Männlich</mat-grid-tile>
        <mat-grid-tile colspan="2" class="property">20</mat-grid-tile>
        <mat-grid-tile colspan="6" class="incident-property" style="background-color: lightgrey;"><i>Betroffene ({{selectedIncidentData?.numberOfPatients}})</i>  </mat-grid-tile>
        <ng-container *ngFor="let patient of selectedIncidentData?.patients">
          <mat-grid-tile colspan="3" class="key-normal">{{patient.sex}}</mat-grid-tile>
          <mat-grid-tile colspan="3" class="property">{{patient.age}}</mat-grid-tile>
        </ng-container>
      </mat-grid-list>
    </div>
  </div>
  <div class="section-2">
    <div class="center-heading heading-coloring">
      <p style="color: white">Resourcen</p>
      <mat-slide-toggle  [(ngModel)]="showDispatched" matTooltip="Zugewiesene Resourcen anzeigen" style="position:absolute; right: 10px;">
      </mat-slide-toggle>
    </div>

    <button style="position:absolute; bottom: 15px; right: 20px; z-index: 999;" color="primary" mat-flat-button (click)="dispatchIncident()"
    [disabled]="selectedIncident === null" aria-label="Einsatz dispatchen">
    Dispatch
  </button>

    <mat-tab-group class="resource-tabs">
      <mat-tab label="Standard">
        <div class="section-vert-3 scrollsection">

          <table mat-table [dataSource]="resources" class="mat-elevation-z8">

            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef> Location </th>
              <td mat-cell *matCellDef="let element"> {{element.location}} </td>
            </ng-container>

            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef> ID </th>
              <td mat-cell *matCellDef="let element"> {{element.id}} </td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef> Type </th>
              <td mat-cell *matCellDef="let element"> <span *ngIf="recommended.has(element.id)"
                  style="color: green;">Empfohlen <br></span> {{element.type}} </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef> Status </th>
              <td mat-cell *matCellDef="let element"> <mat-icon *ngIf="element.assignedIncident" class="notcheck"
                  fontIcon="crisis_alert"></mat-icon>
                <mat-icon *ngIf="!element.assignedIncident" class="check" fontIcon="house"></mat-icon>
              </td>
            </ng-container>

            <ng-container matColumnDef="locate">
              <th mat-header-cell *matHeaderCellDef> Locate </th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button aria-label="Resource lokalisieren" >
                  <mat-icon>location_pin</mat-icon>
                </button>
              </td>
            </ng-container>

            <ng-container matColumnDef="assign">
              <th mat-header-cell *matHeaderCellDef>assign</th>
              <td mat-cell *matCellDef="let element">

                <button *ngIf="!assignedResources?.includes(element)"  (click)="assignResource(element)" mat-icon-button [disabled]="selectedIncident === null"
                aria-label="Ressource zuweisen">
                <mat-icon>add</mat-icon>
              </button>
              <button *ngIf="assignedResources?.includes(element)" (click)="unassignResource(element)" mat-icon-button [disabled]="selectedIncident === null"
              aria-label="Ressource abwählen">
              <mat-icon class="notcheck">close</mat-icon>
            </button>

              </td>
            </ng-container>

            <tr mat-row *matRowDef="let row; columns: displayedColumnsResources;" [ngClass]="{'hidden': !showDispatched && row.assignedIncident}"></tr>
          </table>
        </div>

      </mat-tab>
      <mat-tab label="Zusätzlich">

        <div class="section-vert-3 scrollsection">

          <table mat-table [dataSource]="resourcesAdditional" class="mat-elevation-z8">

            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef> Location </th>
              <td mat-cell *matCellDef="let element"> {{element.location}} </td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef> Type </th>
              <td mat-cell *matCellDef="let element"> {{element.type}} </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef> Status </th>
              <td mat-cell *matCellDef="let element"> <mat-icon *ngIf="element.assignedIncident" class="notcheck"
                fontIcon="crisis_alert"></mat-icon>
              <mat-icon *ngIf="!element.assignedIncident" class="check" fontIcon="house"></mat-icon>
            </td>
            </ng-container>

            <ng-container matColumnDef="locate">
              <th mat-header-cell *matHeaderCellDef> Locate </th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button aria-label="Resource lokalisieren">
                  <mat-icon>location_pin</mat-icon>
                </button>
              </td>
            </ng-container>

            <ng-container matColumnDef="assign">
              <th mat-header-cell *matHeaderCellDef>assign</th>
              <td mat-cell *matCellDef="let element">
                <button *ngIf="!assignedResources?.includes(element)"  (click)="assignResource(element)" mat-icon-button [disabled]="selectedIncident === null"
                  aria-label="Ressource zuweisen">
                  <mat-icon>add</mat-icon>
                </button>
                <button *ngIf="assignedResources?.includes(element)" (click)="unassignResource(element)" mat-icon-button [disabled]="selectedIncident === null"
                aria-label="Ressource abwählen">
                <mat-icon class="notcheck">close</mat-icon>
              </button>
              </td>
            </ng-container>

            <tr mat-row *matRowDef="let row; columns: displayedColumnsResourcesAdditional;" [ngClass]="{'hidden': !showDispatched && row.assignedIncident}"></tr>
          </table>
        </div>

      </mat-tab>
    </mat-tab-group>

  </div>
  <div class="section-3">
    <div class="map" leaflet [leafletOptions]="options">
    </div>
  </div>
</div>
